# Audit Risks Command

**Purpose**: Analyze risks and mitigations from one or more session summaries and ensure they're properly tracked in the project task backlog.

**Usage**: `/audit-risks <tasks-file> <summary-file-1> [<summary-file-2> ...]`

## Description

This command launches the `risk-task-auditor` agent to perform a comprehensive risk-to-task traceability audit across multiple implementation sessions. The agent will:

1. **Parse session summaries** (one or more) for risks, mitigations, and technical debt
2. **Consolidate risks** from all summary files, detecting duplicates across sessions
3. **Search task backlog** for existing tasks that address each risk
4. **Check task completion status** - distinguishes between completed [X] and pending [ ] tasks
5. **Map risks to tasks** with status-aware traceability links
6. **Mark risks as ADDRESSED** when corresponding tasks are already completed
7. **Identify gaps** where risks lack corresponding tasks OR have only pending tasks
8. **Generate new tasks** ONLY for unaddressed risks (no existing or incomplete tasks)
9. **Update all files** with cross-references and intelligent status annotations
10. **Report results** with clear breakdown: addressed vs. pending vs. new tasks needed

## Examples

### Single Summary (Basic Usage)
```bash
/audit-risks specs/tasks.md docs/session-summary.yaml
```

### Multiple Summaries (Common Use Case)
```bash
/audit-risks specs/tasks.md docs/t001-t015-summary.yaml docs/t016-t030-summary.yaml
```

### With Full Paths (Cortex Project)
```bash
/audit-risks specs/001-cortex-foundation-architecture/tasks.md \
  docs/001-cortex/session-summary/t047-t062-summary.yaml \
  docs/001-cortex/session-summary/t063-t078-summary.yaml \
  docs/001-cortex/session-summary/t079-t094-summary.yaml
```

### Cross-Sprint Audit
```bash
/audit-risks backlog/tasks.md \
  reports/sprint-4-retrospective.yaml \
  reports/sprint-5-retrospective.yaml \
  reports/sprint-6-retrospective.yaml
```

### Other Project Structures
```bash
/audit-risks planning/roadmap.md .sessions/implementation-summary.yml
/audit-risks specs/phase-2-tasks.md reports/*.yaml
```

## Input File Requirements

### Session Summary File (YAML - Generated by speckit.execute)
Must contain a `risks_and_backlog` section with prioritized issues as generated by `/speckit.execute`:
```yaml
risks_and_backlog:
  high_priority:
    - issue: "Issue description"
      impact: "Impact description"
      solution: "Proposed solution"
      estimate: "X hours"
  medium_priority:
    - issue: "Issue description"
      impact: "Impact description"
      solution: "Proposed solution"
      estimate: "X hours"
  low_priority:
    - issue: "Issue description"
      impact: "Impact description"
      solution: "Proposed solution"
      estimate: "X hours"
```

The agent will also process `next_steps` section if present:
```yaml
next_steps:
  immediate:
    - "Task before production"
  next_session:
    - "TXXX: Task description"
```

### Tasks File (Markdown)
Should contain a structured task list with:
- Task IDs (e.g., T001, T054, T191)
- Task descriptions with file paths
- Phase/section organization
- Completion status markers ([ ] or [X])

## Output

The command produces deliverables based on the number of input files:

### 1. Updated Session Summaries (one per input summary file)
Adds intelligent traceability fields to each issue based on task completion status:

#### Example 1: Risk Already Addressed (Task Completed)
```yaml
risks_and_backlog:
  high_priority:
    - issue: "No input validation on user registration"
      impact: "SQL injection vulnerability"
      solution: "Add Zod validation schema"
      estimate: "2 hours"
      mapped_task: "T018 [X] Add Zod validation for registration endpoint"
      status: "✅ ADDRESSED - Task completed"
      resolved_in_session: "t001-t015"  # Session where task was completed
```

#### Example 2: Risk Partially Addressed (Task In Progress)
```yaml
risks_and_backlog:
  medium_priority:
    - issue: "No rate limiting on auth endpoints"
      impact: "Vulnerable to brute force attacks"
      solution: "Apply rate limiting middleware to auth routes"
      estimate: "2 hours"
      mapped_tasks:
        - "T034 [X] Create rate limiting middleware (completed)"
        - "T054a [ ] Apply middleware to auth routes (pending)"
      status: "⚠️ PARTIALLY ADDRESSED - Task T054a pending"
      recommended_action: "Complete T054a to fully mitigate risk"
```

#### Example 3: Risk Not Addressed (New Task Needed)
```yaml
risks_and_backlog:
  high_priority:
    - issue: "Auth tokens stored in localStorage"
      impact: "Vulnerable to XSS attacks"
      solution: "Migrate to httpOnly cookies"
      estimate: "3 hours"
      future_task: "T191 (created by this audit)"
      status: "❌ NOT ADDRESSED - NEW TASK CREATED"
      recommended_action: "Add T191: Migrate auth tokens to httpOnly cookies in Phase 11"
      source_session: "t047-t062"  # Added when processing multiple summaries
```

**Note**: When processing multiple summaries, duplicate risks are detected and only one task is created, with all summaries annotated to reference the same task.

### 2. Updated Tasks File
Inserts new tasks in appropriate phases:
```markdown
- [ ] T054a [US1] Apply rate limiting to auth endpoints in backend/src/server.ts (prevent brute force attacks, use existing T034 middleware)
- [ ] T191 [P] Migrate auth tokens from localStorage to httpOnly cookies (XSS protection)
```

Updates task statistics:
```markdown
**Total Tasks**: 190 → 193
- Phase 3 (US1): 16 → 17 tasks
- Phase 11 (Polish): 19 → 21 tasks
```

### 3. Audit Report
Console output with intelligent status breakdown across all sessions:
```
✅ Risk Audit Complete

Session Summaries Processed: 3 files
  - t047-t062-summary.yaml
  - t063-t078-summary.yaml
  - t079-t094-summary.yaml

Risks Analyzed: 18 items (12 current + 6 technical debt)
  - Unique risks: 14 items
  - Duplicate risks detected: 4 items

Risk Status Breakdown:
  ✅ ADDRESSED (completed tasks): 7 items
     - T018: SQL injection prevention
     - T034: Rate limiting middleware created
     - T045: HTTPS enforcement
     - T052: Database connection pooling
     - T067: Error logging
     - T081: Input sanitization
     - T092: Session timeout handling

  ⚠️ PARTIALLY ADDRESSED (pending tasks): 3 items
     - T054a: Apply rate limiting to auth routes (needs T034)
     - T103: Add monitoring alerts (dashboard created in T098)
     - T156: Optimize database queries (indexes added in T142)

  ❌ NOT ADDRESSED (new tasks created): 4 items
     - T191: Migrate to httpOnly cookies (HIGH priority)
     - T192: Add CSRF protection (HIGH priority)
     - T201: Implement request logging (MEDIUM priority)
     - T247: Add rate limiting to search API (LOW priority)

Task Counts Updated:
  - Total: 190 → 194 tasks (4 new)
  - Completed: 92 tasks (7 address audit risks)
  - Pending: 98 → 102 tasks (3 partially address risks, 4 new)

Files Modified:
  - Session summaries: 3 files, 18 risks annotated with intelligent status
  - Tasks file: 4 new tasks added, statistics updated

Next Steps:
  1. Review 4 new HIGH/MEDIUM priority tasks
  2. Complete 3 pending tasks to fully address risks
  3. Consider 7 addressed risks for removal from active monitoring
```

## When to Use

### Post-Implementation Session (Single Summary)
After completing a single implementation session:
```bash
# Just finished T047-T062 implementation
/audit-risks specs/001-cortex/tasks.md docs/001-cortex/session-summary/t047-t062-summary.yaml
```

### Post-Feature Completion (Multiple Summaries - Recommended)
After completing an entire feature across multiple sessions:
```bash
# Finished entire US1 feature (3 sessions)
/audit-risks specs/tasks.md \
  docs/t001-t015-summary.yaml \
  docs/t016-t030-summary.yaml \
  docs/t031-t045-summary.yaml
```

This is the **most powerful use case** - it consolidates risks across all implementation sessions for a feature, detects duplicate risks, and ensures comprehensive task coverage.

### Retrospective Audit (All Tasks Completed - Validation Mode)
After completing ALL tasks in a feature, audit historical summaries to validate risk coverage:
```bash
# All T001-T094 tasks are [X] completed, now audit the summaries
/audit-risks specs/001-foundation/tasks.md \
  docs/session-summary/t001-t015-summary.yaml \
  docs/session-summary/t016-t030-summary.yaml \
  docs/session-summary/t031-t094-summary.yaml
```

**Expected outcome**: Most/all risks should show as "✅ ADDRESSED" with references to completed tasks. Any "❌ NOT ADDRESSED" items indicate gaps that need attention before shipping.

**This is your quality gate** - run this before marking a feature as "production-ready".

### Sprint Planning
Before planning next sprint to ensure all risks are tracked:
```bash
/audit-risks planning/backlog.md reports/sprint-retrospective.yaml
```

### Pre-Release (Multiple Summaries)
Before major releases to verify risk coverage across all recent work:
```bash
/audit-risks specs/release-checklist.md \
  docs/phase-1-summary.yaml \
  docs/phase-2-summary.yaml \
  docs/phase-3-summary.yaml
```

### Regular Audits
Periodic checks (weekly/bi-weekly) to maintain backlog health:
```bash
# Process all summaries since last audit
/audit-risks specs/tasks.md docs/session-summary-*.yaml
```

## Agent Details

- **Agent Name**: risk-task-auditor
- **Location**: `~/.claude/agents/project-management/risk-task-auditor.md`
- **Tools Used**: Read, Edit, Grep, TodoWrite
- **Color**: Orange (warning/attention)

## Benefits

### Core Intelligence
✅ **Status-Aware Risk Tracking**: Distinguishes between addressed, partially addressed, and unaddressed risks based on task completion status [X] vs [ ]

✅ **Zero False Positives**: Won't create duplicate tasks if risk is already addressed by completed work

✅ **Quality Gate Validation**: Confirms all identified risks are mitigated before shipping

✅ **Retrospective Analysis**: Can audit historical summaries even after all work is complete

### Single Summary Benefits
✅ **Zero Untracked Risks**: Every identified risk has a corresponding task or documented deferral

✅ **Bidirectional Traceability**: Clear links from risks → tasks and implicitly tasks → risks

✅ **Automated Task Generation**: No manual task creation for routine risk mitigations (only when truly needed)

✅ **Consistent Prioritization**: HIGH severity risks automatically get appropriate placement

✅ **Audit Trail**: Complete history of what was addressed when and why

✅ **Reduced Overhead**: Automated cross-referencing saves manual tracking time

### Multiple Summary Benefits (Added Value)
✅ **Duplicate Detection**: Identifies when the same risk appears across multiple sessions

✅ **Cross-Session Validation**: Ensures risks identified early are still addressed later

✅ **Complete Feature Audit**: Audit all implementation work for a feature in one pass

✅ **Historical Context**: Track which session identified which risks

✅ **Bulk Processing**: Process weeks or months of summaries in seconds

✅ **Progress Visibility**: See how many risks were addressed over time

## Tips

### File Path Tips
- Use relative paths from project root for portability
- Tab completion works for file paths
- Drag & drop files into terminal to auto-populate paths
- Use wildcards for batch processing: `docs/*.yaml` or `docs/session-*.yaml`
- List tasks file first, then summary files (easier to remember)

### Multiple Summary Tips
- **Process chronologically**: List summaries in order (oldest to newest) for better context
- **Use naming conventions**: Name summaries like `t001-t015-summary.yaml` for easy identification
- **Batch by feature**: Process all summaries for a feature together
- **Review duplicate detection**: Check which risks appear multiple times and verify they're truly duplicates
- **Track source sessions**: The agent annotates which session identified each risk

### Intelligent Status Detection Tips
- **Completion markers matter**: Agent checks `[X]` vs `[ ]` to determine if risk is addressed
- **Run after implementation**: Best results when auditing summaries AFTER completing tasks
- **Quality gate pattern**: Complete tasks → audit summaries → verify all risks addressed
- **Partial completion awareness**: Agent detects when risk needs multiple tasks and some are done
- **No false positives**: Agent won't create new task if existing completed task addresses the risk
- **Retrospective power**: Can audit summaries from weeks/months ago to validate everything was addressed

### Pre-Release Quality Gate Workflow
1. Complete all feature tasks (mark as [X])
2. Run `/audit-risks` with all summaries for that feature
3. Review audit report for "❌ NOT ADDRESSED" items
4. If any critical risks remain: add tasks, complete them, re-run audit
5. When all high/medium risks show "✅ ADDRESSED", feature is ready to ship

### Risk Severity Guidelines
- **HIGH**: Security vulnerabilities, data loss, system downtime
- **MEDIUM**: UX degradation, performance issues, privacy concerns
- **LOW**: Code quality, documentation, nice-to-have improvements

### Task Placement Strategy
- **HIGH severity**: Current or next phase
- **MEDIUM severity**: Relevant feature phase or Phase 11 (Polish)
- **LOW priority**: Phase 11 (Polish) or deferred backlog

### Review Before Commit
After running audit:
1. Review generated tasks for accuracy
2. Verify task placement makes sense
3. Check task ID sequences are correct
4. Confirm risk mappings are appropriate
5. Review duplicate detection (if processing multiple summaries)
6. Verify all summary files were updated correctly
7. Commit all files together with descriptive message

## Common Scenarios

### Scenario 1: Fresh Implementation (Real-Time Audit)
- **When**: Right after completing implementation session
- **State**: Most tasks pending [ ], some completed [X]
- **Expected result**: Mix of addressed/pending/new tasks
- **Action**: Review new tasks, plan which to tackle next

### Scenario 2: Feature Complete (Quality Gate)
- **When**: After marking all feature tasks as [X] completed
- **State**: All related tasks completed [X]
- **Expected result**: Most risks show "✅ ADDRESSED", few/no new tasks
- **Action**: Verify all risks addressed, ship feature with confidence

### Scenario 3: Retrospective Audit (Validation)
- **When**: Weeks/months after implementation
- **State**: All tasks completed [X], reviewing old summaries
- **Expected result**: All risks should be "✅ ADDRESSED"
- **Action**: If any gaps found, they're tech debt to address

### Scenario 4: Partial Implementation (Work In Progress)
- **When**: Mid-feature, some tasks done, some pending
- **State**: Mixed [X] and [ ] status
- **Expected result**: Partially addressed risks + pending tasks
- **Action**: Continue implementation, prioritize based on risk severity

## Troubleshooting

**File not found**: Verify paths are correct and relative to project root

**No risks section**: Ensure summary files have `risks_and_backlog` section

**Task ID conflicts**: Agent checks existing IDs, but review generated IDs manually

**Wrong phase placement**: Agent uses heuristics; manually move tasks if needed

**Argument order confusion**: Remember - tasks file FIRST, then summary file(s)

**Wildcard doesn't work**: Ensure your shell expands wildcards (e.g., `bash` does, some shells don't)

**Too many summaries**: No practical limit, but consider grouping by feature for clarity

**Duplicate detection issues**: If same risk is marked as different, it may be worded differently - review manually

**Some summaries not updated**: Verify all summary paths were correct and files are writable

**All risks showing "NOT ADDRESSED" despite completed tasks**: Agent may not be finding task descriptions that match risk solutions - review task descriptions for semantic match

---

**Related Commands**: `/speckit.analyze`, `/backlog-strategist`
**Agent Category**: Project Management
**Created**: 2025-10-13
